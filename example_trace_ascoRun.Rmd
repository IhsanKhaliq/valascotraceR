---
title: "Example_run"
author: "Vignette author"
date: "`r Sys.Date()`"
output: html_document
---

```{r load_libraries, message=FALSE}
library(ascotraceR)
library(lubridate)
library(data.table)
library(future)
library(readxl)
library(dplyr)
library(ggplot2)
library(patchwork)
```

## Aims

To validate the ascotraceR spatial model with field data.  

## Experimental design

We refer to a paddock as being a spatial unit made up of 1 meter x 1 meter spatial sub-units.
A paddock measures a length of 20 meters and width of 20 meters.
There are four replicate paddocks at each site.  

A quadrant refers to a 1 meter x 1 meter spatial unit inside a paddock.

The experiment was conducted at two locations, Billa Billa and Tosari, Queensland, AU.

## Billa Billa  

Import Billa Billa's weather data.

```{r import_Billa_Billa_weather}
Billa_Billa <-
   fread("data/2020_Billa_Billa_weather_data_ozforecast.csv")

Billa_Billa[, local_time := dmy_hm(local_time)]
```

The Billa Billa weather data needs formatting

```{r}
# specify the station coordinates of the Billa Billa weather station
Billa_Billa[, c("lat", "lon") := .(-28.1011505, 150.3307084)]

Billa_Billa <- format_weather(
  x = Billa_Billa,
  POSIXct_time = "local_time",
  temp = "mean_daily_temp",
  ws = "ws",
  wd_sd = "wd_sd",
  rain = "rain_mm",
  wd = "wd",
  station = "location",
  time_zone = "Australia/Brisbane",
  lon = "lon",
  lat = "lat"
)
```

First we run the model based on what we discussed.
Because the model is stochastic, we'll run it 20 times and compare the average outputs.

```{r trace_asco-Billa_Billa}
billa_list <- vector(mode = "list", length = 20)
time_run_vec <-
  vector(mode = "numeric", length = length(billa_list))

plan(multisession)
for (i in seq_len(20)) {
  T1 <- proc.time()[[3]]
  billa_list[[i]] <-
    trace_asco(
      weather = Billa_Billa,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-07-16"),
      sowing_date = as.POSIXct("2020-06-04"),
      harvest_date = as.POSIXct("2020-10-27"),
      time_zone = "Australia/Brisbane",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.6,
      latent_period_cdd = 150,
      primary_infection_intensity = 200,
      primary_infection_foci = "centre"
    )
  
  T2 <- proc.time()[[3]]
  time_run_vec[i] <- sum(T2, -T1)
}
```

Average model runtime was `r mean(time_run_vec)` for `r length(billa_list)` simulations.

Inspect the severity of the paddock sub-quadrats.

```{r heatmap}
billa <- rbindlist(lapply(billa_list, tidy_trace), idcol = TRUE)

ggplot(data = subset(billa, i_day == 145),
       aes(x = x, y = y, fill = infectious_gp)) +
  geom_tile() +
  scale_fill_viridis_c(option = "E",
                       "Infectious growing points") +
  facet_wrap(.id ~ .) +
  labs(x = "x (m)",
       y = "y (m)") +
  theme_classic() +
  theme(legend.position = "top") +
  guides(fill = guide_colorbar(
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(20, "lines"),
    barheight = unit(0.5, "lines")
  )) +
  coord_equal()
```

Plot a cross sections of the paddock's y-axis at 10m on the x-axis.

```{r plot-billa-cross-section}
ggplot(subset(billa, x == 10),
       aes(x = infectious_gp, y = y, colour = .id)) +
  geom_hex(bins = 25) +
  scale_fill_viridis_c(option = "E") +
  labs(x = "Infectious growing points at 10m on x-axis",
       y = "y-axis (m)") +
  theme_classic() +
  theme(legend.position = "top") +
  guides(fill = guide_colorbar(
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(20, "lines"),
    barheight = unit(0.5, "lines")
  ))
```

Plot the increase in disease over time as the proportion of infected plots.

Taking the data.frame object, mutate it to create a column that indicates whether a quadrat is infected or not, then group by `.id` and `i_date` and calculate the percent infection as the number of infected quadrats per paddock on `i_date` as `infected / number of rows`.

```{r disease_over_time}
billa <- 
  billa %>% 
  mutate(infected = if_else(infectious_gp > 0, TRUE, FALSE, NA)) %>%
  group_by(i_date) %>% 
  mutate(p_inf = sum(infected, na.rm = TRUE) / n())
```

Import field observations
```{r import-billa-obs}
obs_dat <- setDT(readxl::read_xlsx("data/field_experiment_data.xlsx"))
```

```{r billa-proportions}
obs_billa <-
  obs_dat[location == "Billa Billa", sum(infected_plants > 0) /
            .N, by = .(distance, location, assessment_date, plot_number)]

obs_billa <-
  obs_billa %>%
  mutate(assessment_date = as.Date(assessment_date)) %>%
  group_by(assessment_date) %>%
  mutate(i_perc = mean(V1))

billa_proportions <-
  ggplot(obs_billa, aes(x = assessment_date, y = i_perc)) +
  geom_line(aes(linetype = "Observed")) +
  geom_line(
    data = billa,
    alpha = 0.5,
    aes(
      x = i_date,
      y = p_inf,
      group = .id,
      linetype = "Model"
    ),
  ) +
  labs(x = "Assessment Date", y = "Proportion of Infected Quadrats") +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.spacing.y = unit(0, "mm"),
    panel.border = element_rect(colour = "black", fill = NA),
    aspect.ratio = 1,
    axis.text = element_text(colour = 1, size = 12),
    legend.background = element_blank(),
    legend.box.background = element_rect(colour = "black"),
    legend.position = c(0.25, 0.84)
  )
```

## Tosari

Import Tosari's weather data and format the time as a date object.

```{r tosari-weather-import}
Tosari <- fread("data/2020_Tosari_weather_data_ozforecast.csv")

Tosari[, local_time := dmy_hm(local_time)]
```

Pass the data through `format_weather() function from _ascotraceR_.

```{r tosari-weather-format}
# specify the station coordinates of the Billa Billa weather station
Tosari[, c("lat", "lon") := .(-27.856248, 151.447391)]

Tosari <- format_weather(
  x = Tosari,
  POSIXct_time = "local_time",
  temp = "mean_daily_temp",
  ws = "ws",
  wd_sd = "wd_sd",
  rain = "rain_mm",
  wd = "wd",
  station = "location",
  time_zone = "Australia/Brisbane",
  lon = "lon",
  lat = "lat"
)
```

Run the model.

```{r tosari-trace-asco}
tosari_list <- vector(mode = "list", length = 20)
time_run_vec <-
  vector(mode = "numeric", length = length(tosari_list))

for (i in seq_len(length(tosari_list))) {
  T1 <- Sys.time()
  tosari_list[[i]] <-
    trace_asco(
      weather = Tosari,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-07-30"),
      sowing_date = as.POSIXct("2020-06-27"),
      harvest_date = as.POSIXct("2020-11-05"),
      time_zone = "Australia/Brisbane",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.6,
      latent_period_cdd = 150,
      primary_infection_intensity = 200,
      primary_infection_foci = "centre"
    )
  
  T2 <- Sys.time()
  time_run_vec[i] <- T2 - T1
}
```

Average model runtime was `r mean(time_run_vec)` for `r length(tosari_list)` simulations.

```{r plot-tosari-cross-section}
tosari <- rbindlist(lapply(tosari_list, tidy_trace), idcol = TRUE)

ggplot(data = subset(tosari, i_day == 131),
       aes(x = x, y = y, fill = infectious_gp)) +
  geom_tile() +
  scale_fill_viridis_c(option = "E",
                       "Infectious growing points") +
  facet_wrap(.id ~ .) +
  labs(x = "x (m)",
       y = "y (m)") +
  theme_classic() +
  theme(legend.position = "top") +
  guides(fill = guide_colorbar(
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(20, "lines"),
    barheight = unit(0.5, "lines")
  )) +
  coord_equal()
```

Import field observations data for Tosari

```{r}
obs_tosari <-
  obs_dat[location == "Tosari", sum(infected_plants > 0) /
            .N, by = .(distance, location, assessment_date, plot_number)]
```

Plot the increase in disease over time as the proportion of infected plots for Tosari

```{r}
tosari <- 
  tosari %>% 
  mutate(infected = if_else(infectious_gp > 0, TRUE, FALSE, NA)) %>%
  group_by(i_date) %>% 
  mutate(p_inf = sum(infected, na.rm = TRUE) / n())

obs_tosari <-
  obs_tosari %>%
  mutate(assessment_date = as.Date(assessment_date)) %>%
  group_by(assessment_date) %>%
  mutate(i_perc = mean(V1))

tosari_proportions <-
  ggplot(obs_billa, aes(x = assessment_date, y = i_perc)) +
  geom_line(aes(linetype = "Observed")) +
  geom_line(
    data = tosari,
    alpha = 0.5,
    aes(
      x = i_date,
      y = p_inf,
      group = .id,
      linetype = "Model"
    ),
  ) +
  labs(x = "Assessment Date", y = "Proportion of Infected Quadrats") +
  theme_classic() +
  theme(
    legend.position = "none",
    panel.border = element_rect(colour = "black", fill = NA),
    aspect.ratio = 1,
    axis.text = element_text(colour = 1, size = 12)
  )
```

## Combind the plots of proportion over time

```{r combined-plots, fig.cap = "Observed proportion of diseased sites versus model predictions over time for, A) Billa Billa, Qld and B) Tosari, Qld. Observed data are shown with the dotted line. The model is shown with a solid line. The model line is the mean of 20 stochastic model runs."}
billa_proportions +
  tosari_proportions +
  plot_annotation(tag_levels = 'A')
```
