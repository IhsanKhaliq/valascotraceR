---
title: "Example_run"
author: "Dr. Paul Melloy"
date: "06/08/2021"
output: html_document
---

```{r load_libraries}
library(ascotraceR)
library(data.table)
library(callr)
library(readxl)
```
## Aims
To validate the ascotraceR spatial model with field data.  

## Experimental design
We refer to a paddock as being a spatial unit made up of 1 meter x 1 meter spatial units. 
A paddock measures a length of 20 meters and width of 20 meters.
Paddocks are replicated at each site.  

A quadrant refers to a 1 meter x 1 meter spatial unit inside a paddock.  

The experiment was conducted at two locations, Billa Billa and Tosari.

## Billa Billa  

Import Billa Billa's weather data

```{r import_Billa_Billa_weather}
Billa_Billa2 <-
   fread("data/2020_Billa_Billa_weather_data_ozforecast.csv")

lubridate::dmy_hm(Billa_Billa$local_time)

Billa_Billa[, local_time := lubridate::dmy_hm(local_time)]

```

The Billa Billa weather needs formating
```{r}
# specify the station coordinates of the Billa Billa weather station
Billa_Billa[, c("lat", "lon") := .(-28.1011505,150.3307084)]

Billa_Billa <- format_weather(
  x = Billa_Billa,
  POSIXct_time = "local_time",
  temp = "mean_daily_temp",
  ws = "ws",
  wd_sd = "wd_sd",
  rain = "rain_mm",
  wd = "wd",
  station = "location",
  time_zone = "Australia/Brisbane",
  lon = "lon",
  lat = "lat"
)

# calculate the number of wet_hours in a day
Billa_Billa[, wet_hours := sum(rain >0), by = .(YYYY,MM,DD)]

```

First we run the model based on what we discussed.
I am going to run this in a background process using the package callr.
This frees up the console to continue work while we wait for the model.
```{r trace_asco-Billa_Billa}
billa <- vector(mode = "list", length = 4)
future::plan("multiprocess")
for(i in 1:4) {
  T1 <- Sys.time()
  billa[[i]] <-
    trace_asco(
      weather = Billa_Billa,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-07-17"),
      sowing_date = as.POSIXct("2020-06-04"),
      harvest_date = as.POSIXct("2020-10-27"),
      time_zone = "Australia/Brisbane",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.6,
      #min = 0.15 - max = 0.6 (step 0.05)
      latent_period_cdd = 150,
      primary_infection_intensity = 100,
      primary_infection_foci = "centre"
    )
  
  T2 <- Sys.time()
  cat("\nTime run =", T2 - T1)
}

```

Inspect the severity of the paddock
```{r}
tracer_plot(billa, 147)
```

plot cross sections of the paddock
```{r}
# plot the output of all models with the blue line showing the mean
# cross section plot at row 10 (x == 10)
plot(
  apply(as.data.frame(lapply(billa, function(x) {
    x[[147]][["paddock"]][x == 10, infectious_gp]
  })), 1, mean),
  ylab = "infectious_gp",
  xlab = "(y) columns",
  type = "l",
  lwd = 2,
  col = "blue"
)
lines(billa[[1]][[147]][["paddock"]][x == 10, infectious_gp], col = "grey20")
lines(billa[[2]][[147]][["paddock"]][x == 10, infectious_gp], col = "grey20")
lines(billa[[3]][[147]][["paddock"]][x == 10, infectious_gp], col = "grey20")
lines(billa[[4]][[147]][["paddock"]][x == 10, infectious_gp], col = "grey20")

# # cross section plot at row 10 (x == 10)
# plot(billa[[147]][["paddock"]][x == 10, infectious_gp] / 40,
#      ylab = "infectious_gp",
#      xlab = "(y) columns",
#      main = "infectious_gp per plant",
#      type = "l")
# 
# # cross section plot at row 10 (x == 10)
# plot(billa[[147]][["paddock"]][x == 10, infectious_gp/(infectious_gp + susceptible_gp)] / 40,
#      ylab = "infectious_gp",
#      xlab = "(y) columns",
#      main = "percentage infectious_gp per plant",
#      type = "l")
```

Plot the increase in disease over time as the proportion of infected plots
```{r}
prop_infect <-
  rbindlist(lapply(billa[[1]], function(x) {
    data.frame(date = x$i_date,
               p_inf = nrow(x$infected_coords) / nrow(x$paddock))
  }))


```

Import field observations
```{r}
obs_dat <- setDT(readxl::read_xlsx("data/field_experiment_data.xlsx"))
```

```{r}
obs_billa <-
  obs_dat[location == "Billa Billa", sum(infected_plants > 0) /
            .N, by = .(location, assessment_date, plot_number)]

plot(obs_billa[location == "Billa Billa", mean(V1), by = assessment_date],
     pch = 16,
     col = "blue",
     lwd = 2)
lines(obs_billa[location == "Billa Billa", mean(V1), by = assessment_date],
     col = "blue",
     lwd = 2)
lines(prop_infect,
      col = "brown",
      lwd = 2)
```


Now to subset the data to Billa Billa and calculate the proportion of infected quadrants.


## Tosari

Import Tosari's weather data

```{r import-Tosari-weather}
Tosari <-
   fread(system.file("extdata",
            "2020_Tosari_weather_data_ozforecast.csv", package = "ascotraceR"))

```


Run the model for Tosari

```{r trace_asco-Tosari}
ex_asco <- 
  r_bg(function() {
    T1 <- Sys.time()
    library(ascotraceR)
    
    Tosari <-
      data.table::fread(
        system.file(
          "extdata",
          "2020_Billa_Billa_weather_data_ozforecast.csv",
          package = "ascotraceR"
        )
      )
    station_data <-
      system.file("extdata", "stat_dat.csv", package = "ascotraceR")
    
    Tosari <- format_weather(
      x =  Tosari,
      POSIXct_time = "local_time",
      temp = "mean_daily_temp",
      ws = "ws",
      wd_sd = "wd_sd",
      rain = "rain_mm",
      wd = "wd",
      station = "location",
      time_zone = "Australia/Brisbane",
      lonlat_file = station_data
    )
    

    
    ex_at <- trace_asco(
      weather =  Tosari,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-27-06") + lubridate::ddays(34),
      sowing_date = as.POSIXct("2020-27-06"),
      harvest_date = as.POSIXct("2020-11-05") + lubridate::ddays(132) ,
      time_zone = "Australia/Brisbane",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.22,
      latent_period_cdd = 150,
      primary_infection_intensity = 100
    )
    
    save(ex_at, file = "ascotraceR_exOut.rda")
    T2 <- Sys.time()
    T2 - T1
  }, stdout = "tmp/ExampleOut_ta",
  stderr = "tmp/ExampleError_ta")
```

