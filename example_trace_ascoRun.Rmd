---
title: "Validation of ascotraceR using two paddock sites in southern Queensland"
output: html_document
---

```{r load_libraries, message=FALSE}
library(ascotraceR)
library(foreach)
library(lubridate)
library(data.table)
library(future)
library(readxl)
library(dplyr)
library(ggplot2)
library(patchwork)
library(tictoc)
```

## Aims

To validate the _ascotraceR_ spatio-temporal model with observed field data.

## Experimental design

We refer to a paddock as being a spatial unit made up of 1 metre x 1 metre spatial sub-units.
A paddock measures a length of 20 metres and width of 20 metres.
There are four replicate paddocks at each site.

A quadrat refers to a 1 metre x 1 metre spatial unit inside a paddock.

The experiment was conducted at two locations, Billa Billa and Tosari, Queensland, AU.

## Billa Billa

### Billa Billa weather

Import Billa Billa's weather data.

```{r import_Billa_Billa_weather}
Billa_Billa <-
   fread("data/2020_Billa_Billa_weather_data_ozforecast.csv")

Billa_Billa[, local_time := dmy_hm(local_time)]
```

The Billa Billa weather data needs formatting, to do that we need to use `format_weather()` from _ascotraceR_.

```{r format-billa-weather}
# specify the station coordinates of the Billa Billa weather station
Billa_Billa[, c("lat", "lon") := .(-28.1011505, 150.3307084)]

Billa_Billa <- format_weather(
  x = Billa_Billa,
  POSIXct_time = "local_time",
  temp = "mean_daily_temp",
  ws = "ws",
  wd_sd = "wd_sd",
  rain = "rain_mm",
  wd = "wd",
  station = "location",
  time_zone = "Australia/Brisbane",
  lon = "lon",
  lat = "lat"
)
```

### Run _ascotraceR_ for Billa Billa

First we run the model based on what we discussed.
Because the model is stochastic, we'll run it 20 times and compare the average outputs with the observed data.

```{r trace_asco-Billa_Billa}
billa_list <- vector(mode = "list", length = 20)

n_cores <- 4
#create the cluster
my_cluster <- parallel::makeCluster(n_cores,
                                    type = "PSOCK")
doParallel::registerDoParallel(cl = my_cluster)
tic()
billa_list <-
  foreach(i = seq_len(length(billa_list))) %dopar% {
    ascotraceR::trace_asco(
      weather = Billa_Billa,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-07-16"),
      sowing_date = as.POSIXct("2020-06-04"),
      harvest_date = as.POSIXct("2020-10-27"),
      time_zone = "Australia/Brisbane",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.6,
      latent_period_cdd = 150,
      primary_inoculum_intensity = 200,
      primary_infection_foci = "centre"
    )
  }
toc()
parallel::stopCluster(cl = my_cluster)
```

### Heatmap of severity on the final day

Inspect the severity of the paddock sub-quadrats.

```{r billa-heatmap, fig.cap="Heatmap of average infected growing points for 20 model runs for Billa Billa.", message=FALSE}
# create a single data.table object of the list output from `trace_asco()`
billa <- rbindlist(lapply(billa_list, tidy_trace), idcol = TRUE)

# create a new object of xy values scaled to match field observations with 0, 0
# at the middle rather than lower-left and add to `billa` object
xy_scaled <- CJ(-9:10, -9:10)
colnames(xy_scaled) <- c("x_scaled", "y_scaled")
xy_scaled <-
  xy_scaled %>%
  mutate(
    quadrat = case_when(
      x_scaled == 0 & y_scaled == 0 ~ "F",
      x_scaled == 0 & y_scaled == 9 ~ "N9",
      x_scaled == 9 & y_scaled == 9 ~ "NE9",
      x_scaled == -9 & y_scaled == 9 ~ "NW9",
      x_scaled == 9 & y_scaled == 0 ~ "E9",
      x_scaled == 9 & y_scaled == -9 ~ "SE9",
      x_scaled == 0 & y_scaled == -9 ~ "S9",
      x_scaled == -9 & y_scaled == -9 ~ "SW9",
      x_scaled == -9 & y_scaled == 0 ~ "W9",
      x_scaled == 0 & y_scaled == 6 ~ "N6",
      x_scaled == 6 & y_scaled == 6 ~ "NE6",
      x_scaled == -6 & y_scaled == 6 ~ "NW6",
      x_scaled == 6 & y_scaled == 0 ~ "E6",
      x_scaled == 6 & y_scaled == -6 ~ "SE6",
      x_scaled == 0 & y_scaled == -6 ~ "S6",
      x_scaled == -6 & y_scaled == -6 ~ "SW6",
      x_scaled == -6 & y_scaled == 0 ~ "W6",
      x_scaled == 0 & y_scaled == 3 ~ "N3",
      x_scaled == 3 & y_scaled == 3 ~ "NE3",
      x_scaled == -3 & y_scaled == 3 ~ "NW3",
      x_scaled == 3 & y_scaled == 0 ~ "E3",
      x_scaled == 3 & y_scaled == -3 ~ "SE3",
      x_scaled == 0 & y_scaled == -3 ~ "S3",
      x_scaled == -3 & y_scaled == -3 ~ "SW3",
      x_scaled == -3 & y_scaled == 0 ~ "W3",
      TRUE ~ "other"
    )
  )

billa <- cbind(billa, xy_scaled)

billa_summary <- 
  billa %>% 
  filter(i_day == 145) %>%
  group_by(i_date, x_scaled, y_scaled) %>%
  summarise(infectious_gp = mean(infectious_gp)) %>% 
  ungroup()

ggplot(data = billa_summary,
       aes(x = x_scaled, y = y_scaled, fill = infectious_gp)) +
  geom_tile() +
  scale_fill_viridis_c(option = "E",
                       "Infectious growing points",
                       direction = -1) +
  labs(x = "x (m)",
       y = "y (m)") +
  theme_classic() +
  theme(legend.position = "top") +
  guides(fill = guide_colorbar(
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(20, "lines"),
    barheight = unit(0.5, "lines")
  )) +
  coord_equal()
```

### Disease progress over time

Plot the increase in disease over time as the proportion of infected plots.

Taking the model predictions data frame, filter only the quadrats that were surveyed, mutate it to create a column that indicates whether a quadrat is infected or not, then group by `.id` and `i_date` and calculate the percent infection as the number of infected quadrats per paddock on `i_date` as `infected / number of rows`.

```{r filter-billa-quadrats}
billa <- 
  billa %>% 
  filter(quadrat != "other") %>% 
  mutate(infected = if_else(infectious_gp > 0, TRUE, FALSE, NA)) %>%
  group_by(i_date) %>% 
  summarise(p_inf = sum(infected) / n())
```

Import field observations for including in graph.

```{r import-billa-obs}
obs_dat <- 
  setDT(read_xlsx("data/field_experiment_data.xlsx"))
```

Create a line graph of the observed disease over time with the model prediction over layered.
The plot will display the proportion of infected quadrats on day "x".

```{r billa-proportions, fig.cap="Proportion of infected sites over time at Billa Billa. The line represents the mean of 20 stochastic model runs"}
obs_billa <-
  obs_dat[location == "Billa Billa", sum(infected_plants > 0) /
            .N, by = .(distance, location, assessment_date, plot_number, quadrat)]

obs_billa <-
  obs_billa %>%
  mutate(assessment_date = as.Date(assessment_date)) %>%
  group_by(assessment_date) %>%
  mutate(i_perc = mean(V1))

billa_proportions <-
  ggplot(obs_billa, aes(x = assessment_date, y = i_perc)) +
  geom_line(aes(linetype = "Observed")) +
  geom_line(
    data = billa,
    aes(
      x = i_date,
      y = p_inf,
      linetype = "Model"
    ),
  ) +
  labs(x = "Assessment Date", y = "Proportion of Infected Quadrats") +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.spacing.y = unit(0, "mm"),
    panel.border = element_rect(colour = "black", fill = NA),
    aspect.ratio = 1,
    axis.text = element_text(colour = 1, size = 12),
    legend.background = element_blank(),
    legend.box.background = element_rect(colour = "black"),
    legend.position = c(0.25, 0.84)
  )

obs_billa
```

## Tosari

### Tosari weather

Import Tosari's weather data and format the time as a date object.

```{r tosari-weather-import}
Tosari <- fread("data/Tosari_2020_Goanna_weather.csv")[Time != "",]

# Format time to POSIXct
Tosari[, local_time := 
           as.POSIXct(
             unlist(
               lapply(strsplit(Time, " "),
                      function(x) paste(x[2:5],collapse = " "))
             ),
    format = "%B %d %Y %T",
    tz = "Australia/Brisbane")
       ]

# add station name
Tosari[ ,location := "tosari"]

# Remove erroring dates

Tosari <- Tosari[is.na(`Air Temp`)== FALSE, ]
```

Pass the data through `format_weather() function from _ascotraceR_.

```{r tosari-weather-format}
# specify the station coordinates of the Billa Billa weather station
Tosari[, c("lat", "lon") := .(-27.856248, 151.447391)]

Tosari <- format_weather(
  x = Tosari,
  POSIXct_time = "local_time",
  temp = "Air Temp",
  ws = "Avg Wind Speed",
  rain = "Rain",
  wd = "Avg Direction",
  station = "location",
  time_zone = "Australia/Brisbane",
  lon = "lon",
  lat = "lat"
)
```

### Run _ascotraceR_ for Tosari

Run the model 20 times.

```{r tosari-trace-asco}
tosari_list <- vector(mode = "list", length = 20)

n_cores <- 4
#create the cluster
my_cluster <- parallel::makeCluster(n_cores,
                                    type = "PSOCK")

doParallel::registerDoParallel(cl = my_cluster)
tic()
tosari_list <-
  foreach(i = seq_len(length(tosari_list))) %dopar% {
    ascotraceR::trace_asco(
      weather = Tosari,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-07-30"),
      sowing_date = as.POSIXct("2020-06-27"),
      harvest_date = as.POSIXct("2020-11-05"),
      time_zone = "Australia/Brisbane",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.6,
      latent_period_cdd = 150,
      primary_inoculum_intensity = 200,
      primary_infection_foci = "centre"
    )
  }
toc()
parallel::stopCluster(cl = my_cluster)
```

### Heatmap of severity on the final day

```{r tosari-heatmap, fig.cap="Heatmap of average infected growing points for 20 model runs for Tosari.", message=FALSE}
tosari <- 
  rbindlist(lapply(tosari_list, tidy_trace), idcol = TRUE)

tosari <- cbind(tosari, xy_scaled)

tosari_summary <- 
  tosari %>% 
  filter(i_day == 131) %>%
  group_by(i_date, x_scaled, y_scaled) %>%
  summarise(infectious_gp = mean(infectious_gp)) %>% 
  ungroup()

ggplot(data = tosari_summary,
       aes(x = x_scaled, y = y_scaled, fill = infectious_gp)) +
  geom_tile() +
  scale_fill_viridis_c(option = "E",
                       "Infectious growing points",
                       direction = -1) +
  labs(x = "x (m)",
       y = "y (m)") +
  theme_classic() +
  theme(legend.position = "top") +
  guides(fill = guide_colorbar(
    title.position = "top",
    title.hjust = 0.5,
    barwidth = unit(20, "lines"),
    barheight = unit(0.5, "lines")
  )) +
  coord_equal()
```

### Disease progress over time

Import field observations data for Tosari

```{r import-tosari-obs}
obs_tosari <-
  obs_dat[location == "Tosari", sum(infected_plants > 0) /
            .N, by = .(distance, location, assessment_date, plot_number)]
```

Plot the increase in disease over time as the proportion of infected quadrats for Tosari, comparing the model runs with the observed values.

```{r tosari-proportions, fig.cap="Proportion of infected sites over time at Tosari. The line represents the mean of 20 stochastic model runs"}
tosari <- 
  tosari %>% 
  filter(quadrat != "other") %>% 
  mutate(infected = if_else(infectious_gp > 0, TRUE, FALSE, NA)) %>%
  group_by(i_date) %>% 
  summarise(p_inf = sum(infected, na.rm = TRUE) / n())

obs_tosari <-
  obs_tosari %>%
  mutate(assessment_date = as.Date(assessment_date)) %>%
  group_by(assessment_date) %>%
  summarise(i_perc = mean(V1))

tosari_proportions <-
  ggplot(tosari, aes(x = i_date, y = p_inf)) +
  geom_line(aes(linetype = "Model")) +
  geom_line(data = obs_tosari,
            aes(x = assessment_date, y = i_perc, linetype = "Observed")) +
  labs(x = "Assessment Date", y = "Proportion of Infected Quadrats") +
  theme_classic() +
  theme(
    legend.position = "none",
    panel.border = element_rect(colour = "black", fill = NA),
    aspect.ratio = 1,
    axis.text = element_text(colour = 1, size = 12)
  )

tosari_proportions
```

## Combind the plots of proportion over time

Using _patchwork_ we can combine the plots for Billa Billa and Tosari into a single figure for publication.

```{r combined-plots, fig.cap = "Observed proportion of diseased sites versus model predictions over time for, A) Billa Billa, Qld and B) Tosari, Qld. Observed data are shown with the dotted line. The model is shown with a solid line. The model line is the mean of 20 stochastic model runs using weather data for each respective site."}
billa_proportions +
  tosari_proportions +
  plot_annotation(tag_levels = 'A')
```
