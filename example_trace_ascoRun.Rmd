---
title: "Example_run"
author: "Dr. Paul Melloy"
date: "06/08/2021"
output: html_document
---

```{r load_libraries}
library(ascotraceR)
library(data.table)
library(callr)
```

## Billa Billa

The experiment was conducted at two locations, Billa Billa and Tosari. Import Billa Billa's weather data

```{r import_Billa_Billa_weather}
Billa_Billa <-
   fread(system.file("extdata",
            "2020_Billa_Billa_weather_data_ozforecast.csv", package = "ascotraceR"))
```


First we run the model based on what we discussed.
I am going to run this in a background process using the package callr.
This frees up the console to continue work while we wait for the model.
```{r trace_asco-Billa_Billa}
ex_asco <- 
  r_bg(function() {
    T1 <- Sys.time()
    library(ascotraceR)
    
    Billa_Billa <-
      data.table::fread(
        system.file(
          "extdata",
          "2020_Billa_Billa_weather_data_ozforecast.csv",
          package = "ascotraceR"
        )
      )
    station_data <-
      system.file("extdata", "stat_dat.csv", package = "ascotraceR")
    
    Billa_Billa <- format_weather(
      x = Billa_Billa,
      POSIXct_time = "local_time",
      temp = "mean_daily_temp",
      ws = "ws",
      wd_sd = "wd_sd",
      rain = "rain_mm",
      wd = "wd",
      station = "location",
      time_zone = "Australia/Brisbane",
      lonlat_file = station_data
    )
    

    
    ex_at <- trace_asco(
      weather = Billa_Billa,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-06-04") + lubridate::ddays(43),
      sowing_date = as.POSIXct("2020-06-04"),
      harvest_date = as.POSIXct("2020-10-27") + lubridate::ddays(145) ,
      time_zone = "Australia/Perth",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.22,
      latent_period_cdd = 150,
      primary_infection_intensity = 100
    )
    
    save(ex_at, file = "ascotraceR_exOut.rda")
    T2 <- Sys.time()
    T2 - T1
  }, stdout = "tmp/ExampleOut_ta",
  stderr = "tmp/ExampleError_ta")
```

```{r check_process}
ex_asco$is_alive()
processx::poll(list(ex_asco), 1000)
```

```{r load_file}
load("ascotraceR_exOut.rda")
```

```{r}
tracer_plot(ex_at, 137)

# cross section plot at row 10 (x == 10)
plot(ex_at[[137]][["paddock"]][x == 10, infectious_gp],
     ylab = "infectious_gp",
     xlab = "(y) columns")

# cross section plot at row 10 (x == 10)
plot(ex_at[[137]][["paddock"]][x == 10, infectious_gp] / 40,
     ylab = "infectious_gp",
     xlab = "(y) columns",
     main = "infectious_gp per plant")

# cross section plot at row 10 (x == 10)
plot(ex_at[[137]][["paddock"]][x == 10, infectious_gp/(infectious_gp + susceptible_gp)] / 40,
     ylab = "infectious_gp",
     xlab = "(y) columns",
     main = "percentage infectious_gp per plant")
```


## Tosari

Import Tosari's weather data

```{r import-Tosari-weather}
Tosari <-
   fread(system.file("extdata",
            "2020_Tosari_weather_data_ozforecast.csv", package = "ascotraceR"))

```


Run the model for Tosari

```{r trace_asco-Tosari}
ex_asco <- 
  r_bg(function() {
    T1 <- Sys.time()
    library(ascotraceR)
    
    Tosari <-
      data.table::fread(
        system.file(
          "extdata",
          "2020_Billa_Billa_weather_data_ozforecast.csv",
          package = "ascotraceR"
        )
      )
    station_data <-
      system.file("extdata", "stat_dat.csv", package = "ascotraceR")
    
    Tosari <- format_weather(
      x =  Tosari,
      POSIXct_time = "local_time",
      temp = "mean_daily_temp",
      ws = "ws",
      wd_sd = "wd_sd",
      rain = "rain_mm",
      wd = "wd",
      station = "location",
      time_zone = "Australia/Brisbane",
      lonlat_file = station_data
    )
    

    
    ex_at <- trace_asco(
      weather =  Tosari,
      paddock_length = 20,
      paddock_width = 20,
      initial_infection = as.POSIXct("2020-27-06") + lubridate::ddays(34),
      sowing_date = as.POSIXct("2020-27-06"),
      harvest_date = as.POSIXct("2020-11-05") + lubridate::ddays(132) ,
      time_zone = "Australia/Brisbane",
      seeding_rate = 40,
      gp_rr = 0.0065,
      spores_per_gp_per_wet_hour = 0.22,
      latent_period_cdd = 150,
      primary_infection_intensity = 100
    )
    
    save(ex_at, file = "ascotraceR_exOut.rda")
    T2 <- Sys.time()
    T2 - T1
  }, stdout = "tmp/ExampleOut_ta",
  stderr = "tmp/ExampleError_ta")
```

